{% extends "registration_system/partials/base.html" %}
{% load staticfiles %}
{% block navbar %}
    {% include "registration_system/partials/main_navbar.html" %}
{% endblock %}
{% block content %}

     <div class="ui container">
        {{ rendered|safe }}
    </div>

    <div class="ui container m-top2">
        <div class="ui form" id="ui-form">
            <div class="inline fields">
                <div class="field">
                    <label for="id_department_id">Department</label>
                    <select class="ui fluid dropdown" name="department_id" id="id_department_id" required>
                        {% if departments %}
                            {% for department in departments %}
                                <option value="{{ department.department_id }}" label="{{ department.name }}">{{ department.name }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
            </div>
            <div class="inline fields">
                <div class="field">
                    <label for="id_course_id">Course</label>
                    <select class="ui fluid dropdown" name="course_id" id="id_course_id" required>
                        {% if courses %}
                            {% for course in courses %}
                                <option value="{{ course.course_id }}" label="{{ course.name }}">{{ course.name }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
            </div>
            <div class="fields">
                <div class="ten wide field">
                    <label for="id_faculty_id">Faculty</label>
                    <select class="ui fluid dropdown" name="faculty_id" id="id_faculty_id" required>
                        {% if faculty %}
                            {% for f in faculty %}
                                <option value="{{ f.faculty_id }}" >{{ f.first_name }} {{ f.last_name }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div class="six wide field">
                    <label for="id_days_id">Meeting Days</label>
                    <select class="ui fluid dropdown" name="days_id" id="id_days_id" required>
                        {% if days %}
                            {% for d in days %}
                                <option value="{{ d.days_id }}" >{{ d.day_1 }}--{{ d.day_2 }}{% if d.day_3 is not None %}--{{ d.day_3 }}{% endif %}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
            </div>
            <table class="ui celled table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Professor</th>
                        <th>Credits</th>
                        <th>Seats Taken</th>
                        <th>Seating Capacity</th>
                        <th>Time Period</th>
                        <th>Meeting Days</th>
                        <th>Building</th>
                        <th>Room</th>
                    </tr>
                </thead>
                <tbody id="courses_added">

                </tbody>
            </table>
        </div>
        <div id="success">

        </div>
    </div>
{# TODO: Ajax call to building table and ajax post to submit update #}
    <script>
        function getCourses(){
            removeCourses();
            var department_id = $('#id_department_id').val();
            var department_name = $('select option:selected').text();
            $.ajax({
                type: "GET",
                url: "/student_system/search_course/",
                data : {
                    department_id: department_id,
                    department_name: department_name
                },
                success: function(data) {
                    console.log(data);
                    data.forEach(function(element){
                        var tBody = document.getElementById('courses_added');
                        var newRow = tBody.insertRow(tBody.rows.length);
                        newRow.id = element.course_id + '_row';
                        var courseIdCell = newRow.insertCell(0);
                        var courseNameCell = newRow.insertCell(1);
                        var descriptionCell = newRow.insertCell(2);
                        var departmentCell = newRow.insertCell(3);
                        var creditsCell = newRow.insertCell(4);
                        var updateCell = newRow.insertCell(5);
                        var courseIdText = document.createTextNode(element.course_id);
                        var departmentText = document.createTextNode(element.department_name);
                        courseIdCell.appendChild(courseIdText);
                        departmentCell.appendChild(departmentText);
                        courseNameCell.insertAdjacentHTML('afterbegin',
                            '<div class="ui input">' +
                                '<input type="text" name="course_name" value="'+element.course_name+'" id="id_course_name_'+element.course_id+'" required />' +
                            '</div>' );
                        descriptionCell.insertAdjacentHTML('afterbegin',
                            '<div class="ui input">' +
                                '<textarea class="text-area-styled" name="course_description" maxlength="1000" required id="id_course_description_'+element.course_id+'">'+element.course_description+'</textarea>' +
                            '</div>' );
                        creditsCell.insertAdjacentHTML('afterbegin',
                            '<div class="ui input">' +
                                '<input type="number" name="course_credits" value="'+element.course_credits+'" required id="id_course_credits_'+element.course_id+'" step="1" min="2" max="4"/>' +
                            '</div>' );
                        updateCell.insertAdjacentHTML('afterbegin', '<button type="button" onclick="updateCourse(this.id)" class="ui info button" id="'+element.course_id+'" type="button">Update</button>')
                    });
                }
            });

        }

        function removeCourses() {
            $('#courses_added').empty();
        }

        function updateCourse(course_id) {

            var course_description = $('#id_course_description_'+course_id).val();
            var course_name = $('#id_course_name_'+course_id).val();
            var course_credits = $('#id_course_credits_'+course_id).val();
            $.ajax({
                type: "POST",
                url: "/student_system/search_course/",

                data: {
                    courseID: course_id,
                    courseName: course_name,
                    course_description: course_description,
                    course_credits: course_credits,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },

                success: function(){
                    $('#success').append("<h2>"+course_name+" Update Successfully</h2>")
                }
            })

        }

        $('#id_department_id').change(getCourses)


    </script>

{% endblock %}